<?php defined('BASEPATH') OR exit('No direct script access allowed'); require_once APPPATH . 'controllers/Base.php'; require_once APPPATH.'../vendor/autoload.php';   /**  *  */ class Cetak_buku_tamu extends Base{ 	public function cetak($tahun = null){ 		if($tahun == null){ 			$tahunnya = date('Y'); 		}else{ 			$tahunnya = $tahun; 		} 		$data_buku_tamu = $this->m_data->like(['tanggal'=>$tahunnya])->get('data')->result_object();  		//mulai table 1  		$document_with_table = new \PhpOffice\PhpWord\PhpWord(); 		$styleCell = 			[ 				'borderColor' =>'black', 				'borderSize' => 9, 				'valign'=>'top', 			]; 		$styleCell2 = 			[ 				'borderColor' =>'black', 				'borderSize' => 9, 				'valign'=>'center', 			]; 		$myFontStyle = array('size' => 10, 'align' => 'left'); 		$myFontStyle2 = array('size' => 12, 'align' => 'left','bold' => true); 		$section = $document_with_table->addSection();  		$table = $section->addTable(array('align'=>'center')); 		$table->addRow(600); 		$table->addCell(500,$styleCell2)->addText('No',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$table->addCell(2000,$styleCell2)->addText('Tanggal',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$table->addCell(3000,$styleCell2)->addText('Nama',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$table->addCell(2000,$styleCell2)->addText('Alamat',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$table->addCell(2500,$styleCell2)->addText('Surat Tugas',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$table->addCell(2000,$styleCell2)->addText('Keperluan',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$table->addCell(2000,$styleCell2)->addText('Ttd',$myFontStyle2,array('align' => 'center','spaceAfter' => 0)); 		$template_document = new \PhpOffice\PhpWord\TemplateProcessor(base_url('template/buku_tamu.docx')); 		$no = 1; 		foreach($data_buku_tamu as $dtb): 			$data_tamu = $this->m_data->where(['data_id'=>$dtb->id])->order_by('id','asc')->get('data_tamu'); 			$jumlah_nama_tamu = $data_tamu->num_rows(); 			$nama = ''; 			$ttd = ''; 			$nox = 1; 			$not = 1;  			if($jumlah_nama_tamu > 0){ 				$data_tamunya = $data_tamu->result_object(); 				foreach ($data_tamunya as $dtm): 					$nama .= $nox++.'. '.$dtm->nama.'</w:t><w:br/><w:t></w:t><w:br/><w:t></w:t><w:br/><w:t>'; 					$ttd .= '${ttd'.$no.'_'.$not++.'}';  				endforeach; 			}else{ 				$nama .= ''; 				$ttd .= ''; 			}  			$table->addRow(); 			$table->addCell(500,$styleCell)->addText($no++,$myFontStyle,array('align' => 'center','spaceAfter' => 0)); 			$table->addCell(2000,$styleCell)->addText(tanggal_indonesia($dtb->tanggal),$myFontStyle,array('align' => 'center','spaceAfter' => 0)); 			$table->addCell(3000,$styleCell)->addText($nama,$myFontStyle,array('align' => 'left','spaceAfter' => 0)); 			$table->addCell(2000,$styleCell)->addText($dtb->asal,$myFontStyle,array('align' => 'left','spaceAfter' => 0)); 			$table->addCell(2500,$styleCell)->addText($dtb->surat_tugas,$myFontStyle,array('align' => 'center','spaceAfter' => 0)); 			$table->addCell(2000,$styleCell)->addText($dtb->keperluan,$myFontStyle,array('align' => 'left','spaceAfter' => 0)); 			$table->addCell(2000,$styleCell)->addText($ttd,$myFontStyle,array('align' => 'center','spaceAfter' => 0));  		endforeach;  		$objWriter = \PhpOffice\PhpWord\IOFactory::createWriter($document_with_table, 'Word2007'); 		$fullxml = $objWriter->getWriterPart('Document')->write(); 		$tablexml = preg_replace('/^[\s\S]*(<w:tbl\b.*<\/w:tbl>).*/', '$1', $fullxml);    		$template_document->setValue('table', $tablexml); 		$template_document->setValue('instansi', strtoupper($this->getKonfig('instansi'))); 		$template_document->setValue('tahun', $tahunnya);  		$nomor_ttd = 1; 		foreach($data_buku_tamu as $dtbx): 			$data_tamux = $this->m_data->where(['data_id'=>$dtbx->id])->order_by('id','asc')->get('data_tamu'); 			$jumlah_nama_tamux = $data_tamux->num_rows(); 			$nomer = 1; 			if($jumlah_nama_tamux > 0){  				$data_tamuxnya = $data_tamux->result_object(); 				foreach ($data_tamuxnya as $dtmm): 					$template_document->setImageValue('ttd'.$nomor_ttd.'_'.$nomer++, base_url('assets/ttd/'.$dtmm->ttd)); 				endforeach; 			} 			$template_document->setImageValue('ttd'.$nomor_ttd++.'_1', base_url('assets/ttd/'.$dtmm->ttd));   		endforeach;  		$temp_filename = 'buku_tamu_tahun_'.$tahunnya.'.docx'; 		$template_document->saveAs($temp_filename);  		header('Content-Description: File Transfer'); 		header('Content-Type: application/octet-stream'); 		header('Content-Disposition: attachment; filename='.$temp_filename); 		header('Content-Transfer-Encoding: binary'); 		header('Expires: 0'); 		header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); 		header('Pragma: public'); 		header('Content-Length: ' . filesize($temp_filename)); 		flush(); 		readfile($temp_filename); 		unlink($temp_filename); 		exit; 	}   } 